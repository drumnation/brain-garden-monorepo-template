---
description: Consolidated development rules for the Cortals monorepo (‚â§50% of original content)
alwaysApply: true
---

# Master Development Rules - Cortals Monorepo

**Auto-generated:** Do not edit directly. Generated from modular .mdc files.
**Target:** ‚â§50% of original content while preserving decision trees, commands, and checklists.

---

## 1. MONOREPO FOUNDATION

### Core Principles
- **ESM-Only:** ES Modules exclusively. No CommonJS.
- **No Build for Libraries:** Packages export TypeScript source directly. Runtime transpiler (tsx) handles it.
- **Shared Config:** All tooling (ESLint, Prettier, TS, Testing) centralized in `/tooling`. Never duplicate.
- **Agent Coordination:** Always check `_errors/` and `_logs/` (brain-monitor) before running commands.

### Structure
```
/apps          # Executable applications (@[app-name])
/packages      # Shared libraries (@[app-name]/[package-name])
/tooling       # Shared config (@kit/*)
/_errors       # Validation reports (brain-monitor)
/_logs         # Real-time server logs
```

### Package.json Template (Library)
```json
{
  "name": "@[app-name]/[package-name]",
  "type": "module",
  "exports": {
    ".": "./src/index.ts",
    "./*": "./src/*.ts"
  },
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "typecheck": "tsc --noEmit",
    "test": "vitest run"
  }
}
```

### Environment Variables (@kit/env-loader)
**Loading order:** `monorepo-root/.env` ‚Üí `apps/my-app/.env` ‚Üí `process.env`

```typescript
// Node.js
import { loadEnvironment, requireEnv } from '@kit/env-loader/node';
const result = loadEnvironment({ appName: 'api', required: ['DATABASE_URL'] });
const PORT = requireEnv('PORT');

// Browser (prefix with VITE_)
import { getEnv } from '@kit/env-loader/browser';
const API_URL = getEnv('VITE_API_URL', 'http://localhost:8080');
```

---

## 2. VALIDATION & TESTING WORKFLOW

### Brain Monitor (MANDATORY)
**Always check reports FIRST before running validations:**

```bash
# 1. Check status
cat _errors/validation-summary.md

# 2. Check specific errors
cat _errors/reports/errors.typecheck-failures.md
cat _errors/reports/errors.test-failures-unit.md
```

**Commands:**
| Task | Command | Output |
|------|---------|--------|
| All Validations | `pnpm brain:validate` | `_errors/validation-summary.md` |
| Watch Mode | `pnpm brain:watch` | Real-time updates |
| TypeScript | `pnpm brain:typecheck-failures` | `_errors/reports/errors.typecheck-failures.md` |
| Tests | `pnpm brain:test-failures-unit` | `_errors/reports/errors.test-failures-unit.md` |

**Efficiency Rule:** ONLY run validations if reports are stale (>10min) or missing.

### TDD 5-Step Workflow

**STEP 1: ORIENT & DECIDE**
- Choose test type for max AI verification confidence
- **Browser E2E** (Highest) ‚Üí **Backend E2E** (Very High) ‚Üí **Integration** (High) ‚Üí **Unit** (Low)

**STEP 2: SCAFFOLD**
| Test Type | Path | File Pattern | Runner |
|-----------|------|--------------|--------|
| Unit | `<same-dir-as-source>` | `<name>.unit.test.ts(x)` | Vitest |
| Integration | `testing/integration/` | `<module>.integration.test.ts(x)` | Vitest |
| Backend E2E | `testing/e2e/` | `<scenario>.backend.e2e.test.ts` | Vitest |
| Browser E2E | `testing/e2e/` | `<scenario>.browser.e2e.ts` | Playwright |

**STEP 3: RED** - Write failing test (focus on user-observable behavior)
**STEP 4: GREEN** - Minimal code to pass
**STEP 5: REFACTOR** - Clean up while keeping tests green

### Test Standards
- **Philosophy:** Test real use, not implementation. Mock only external dependencies.
- **One-to-One:** Passing test = feature works. Failing test = something broken.
- **AI Verification First:** Prioritize E2E tests that prove complete workflows work.

---

## 3. FRONTEND ARCHITECTURE

### Component Design Decision Tree

**Step 1: Third-party wrapper?**
- **YES** ‚Üí **Atomic Design** (wrap in `src/ui/atoms|molecules|organisms`)

**Step 2: New reusable component?**
- **YES** ‚Üí **Storybook-First** (build in isolation with `.stories.tsx`)

**Step 3: Different mobile/desktop layouts?**
- **YES** ‚Üí **Platform Pathways** (separate `.web.tsx` and `.mobile.tsx`)
- **NO** ‚Üí **Mobile-First** (single component with responsive CSS)

### Atomic Design
**Wrap ALL third-party components (Mantine, MUI):**
```
src/components/
  atoms/        # Button, Text, Icon
  molecules/    # AvatarWithName, InputWithLabel
  organisms/    # Header, Sidebar, DataTable
  layouts/      # DashboardLayout, AuthLayout
```

**Rules:**
- Atoms üö´ cannot import molecules/organisms
- Molecules may import atoms
- Organisms may import atoms + molecules
- All get Storybook stories

### Platform Pathways Pattern
**When mobile/desktop need drastically different layouts:**
```
ComponentName.tsx        # Entry point (platform detection)
ComponentName.web.tsx    # Desktop implementation
ComponentName.mobile.tsx # Mobile implementation
ComponentName.logic.tsx  # Shared logic
```

```typescript
// ComponentName.tsx
import { useMediaQuery } from '@mantine/hooks';
export const ComponentName = (props) => {
  const isMobile = useMediaQuery(`(max-width: ${theme.breakpoints.sm})`);
  return isMobile ? <ComponentNameMobile {...props} /> : <ComponentNameWeb {...props} />;
};
```

### Mobile-First Design
**Always start with mobile layout, then enhance for desktop:**
```typescript
const Button = styled(MantineButton)`
  /* Mobile-first */
  padding: 12px 16px;
  font-size: 14px;

  @media (min-width: 768px) {
    padding: 14px 24px;
    font-size: 16px;
  }
`;
```

### React Standards (Bulletproof)
- **State buckets:** Local (useState) | UI (Context/Zustand) | Server (React Query) | Form (React-Hook-Form)
- **Co-location:** `Button.tsx`, `Button.test.tsx`, `Button.stories.tsx` together
- **API Layer:** All HTTP in `lib/api/` with React Query hooks
- **Logging:** Use `@kit/logger/browser` (Pino 8)
- **Error Boundaries:** Wrap every feature entry

---

## 4. BACKEND ARCHITECTURE

### Express Architecture (HTTP APIs)
**Use for:** Full Express.js servers in `/apps/server/`

**Structure:**
```
src/
‚îú‚îÄ modules/              # Feature-specific bounded contexts
‚îÇ   ‚îî‚îÄ <feature>/
‚îÇ       ‚îú‚îÄ <feature>.<role>.ts  # controller, service, repo
‚îÇ       ‚îî‚îÄ index.ts             # Barrel export
‚îú‚îÄ shared/               # App-internal shared code
‚îú‚îÄ infra/                # Infrastructure (HTTP, DB)
‚îî‚îÄ main.ts               # Entry point
```

**File Naming:** `<feature>.<role>.ts` where role = controller, service, repo, schema, dto, types, middleware, util, test

**DI Pattern (Functional):**
```typescript
// makeUserRepo.ts
export const makeUserRepo = (deps: { db: DbClient }) => ({
  list: () => deps.db.query<User[]>('SELECT * FROM users'),
});

// makeGetUsers.ts (controller)
export const makeGetUsers = (userRepo: ReturnType<typeof makeUserRepo>) =>
  async (_req, res) => res.json(await userRepo.list());
```

**Limits (enforced via ESLint):**
- Max file: 500 lines
- Max function: 75 lines
- Cyclomatic complexity: ‚â§10
- Nesting depth: ‚â§4

### Functional Isolated Concerns (Scripts/CLIs)
**Use for:** Standalone scripts, CLIs, workers (NOT Express)

**Structure:**
```
feature/
‚îú‚îÄ feature.service.ts     # Pure business logic
‚îú‚îÄ feature.repository.ts  # Data access
‚îú‚îÄ feature.validation.ts  # Pure validation
‚îú‚îÄ feature.types.ts       # TypeScript types
‚îî‚îÄ index.ts               # Exports
```

**Transformation Rules:**
- Classes ‚Üí Pure functions
- Constructor deps ‚Üí Function params or closure
- Instance state ‚Üí Function arguments
- Private methods ‚Üí Non-exported functions

**Refactoring Checklist:**
- [ ] No classes exist
- [ ] All functions pure where possible
- [ ] Side effects isolated
- [ ] Each file = single concern
- [ ] File pattern: `<name>.<purpose>.ts`

---

## 5. DOCUMENTATION & WORKFLOW

### Documentation Hierarchy
1. **Package-level:** `packages/ui/docs/` (implementation details)
2. **Feature-level:** `/docs/features/[name]/` (cross-package features)
3. **Global:** `/docs/architecture/` (system-wide)

**YAML Frontmatter (Required):**
```yaml
---
title: "Feature Name"
description: "Brief description"
keywords: [api, caching, ssr]
related_features: ["dashboard"]
last_updated: "YYYY-MM-DD"
---
```

**File Validation:**
- [ ] README.md exists (Overview, Installation, Usage, API)
- [ ] CHANGELOG.md exists (Keep a Changelog format)
- [ ] package.json version follows SemVer

### PR Creation Workflow

**1. Branch Creation:**
```bash
git checkout qa && git pull origin qa
git checkout -b hotfix/descriptive-name
```

**2. PR Description:**
```markdown
# üöë Hotfix: [Brief Description]

## üîç Issue
[Issue description]

## üõ† Fix
[Fix description]

## üìã Changes
- [Change 1]
- [Change 2]

## üß™ Testing
- [ ] [Test step 1]
- [ ] [Test step 2]

## ‚è∞ Created
[DATE]

#Hotfix #Tags
```

**3. Create PR:**
```bash
printf '[PR content]' > /tmp/pr_description.md
gh pr create --base qa --head hotfix/branch --title "[Title]" --body-file /tmp/pr_description.md
rm /tmp/pr_description.md
```

**Pre-Review Checklist:**
- [ ] Check `_errors/validation-summary.md` for issues
- [ ] All tests pass
- [ ] Updated CHANGELOG.md for affected packages
- [ ] PR description reflects actual changes

### Package Versioning
**SemVer 2.0.0:**
- **MAJOR** (x.0.0) - Breaking API changes
- **MINOR** (0.x.0) - New features (backwards-compatible)
- **PATCH** (0.0.x) - Bug fixes

**Version Sync:**
- CHANGELOG.md version matches package.json
- Move `[Unreleased]` ‚Üí `[x.y.z] - YYYY-MM-DD` on release
- Add new `[Unreleased]` section

---

## 6. ESSENTIAL COMMANDS

### Development
```bash
pnpm dev                    # Start all apps
pnpm build                  # Build all packages
pnpm clean                  # Clean node_modules
```

### Validation (via Brain Monitor)
```bash
pnpm brain:validate         # Run all validations
pnpm brain:watch            # Watch mode (fast)
pnpm brain:typecheck-failures
pnpm brain:test-failures-unit
pnpm brain:lint-failures
```

### Testing
```bash
pnpm test                   # All tests
pnpm test:unit              # Unit tests only
pnpm test:integration       # Integration tests
pnpm test:e2e               # E2E tests
```

### Rules Generation
```bash
pnpm rules:build            # Regenerate consolidated rules
pnpm rules:watch            # Watch mode for rules
```

---

## 7. QUICK REFERENCE

### File Extensions & Types
- `.ts` - TypeScript source (backend/shared)
- `.tsx` - TypeScript + JSX (React components)
- `.test.ts(x)` - Test files
- `.stories.tsx` - Storybook stories
- `.mdc` - Modular rule files (source of truth)

### Import Patterns
- Absolute: `@/features/auth`, `@kit/testing`
- Named exports preferred (no default exports)
- Barrel exports in `index.ts`

### TestID Convention
**Pattern:** `[feature]-[component]-[element]`
```typescript
import { YourPackageTestIds } from '@cortals/testids';
<div data-testid={YourPackageTestIds.FeatureName.Container}>
```

### Proxy Rules (CM Service)
- All CM API requests ‚Üí Proxy server
- Portal-specific data ‚Üí Local PostgreSQL
- **Token format:** Direct value, NO "Bearer" prefix
- Use `apiToken` header, not `Authorization: Bearer`

---

## 8. ANTI-PATTERNS TO AVOID

### Testing
- ‚ùå Snapshot overuse (only for UI structure)
- ‚ùå Testing implementation details
- ‚ùå Over-mocking (use real implementations internally)
- ‚ùå Brittle assertions

### Frontend
- ‚ùå Using third-party components directly (wrap them)
- ‚ùå Inline styles with hex colors (use theme tokens)
- ‚ùå Default exports
- ‚ùå console.log (use @kit/logger)

### Backend
- ‚ùå Classes (use pure functions)
- ‚ùå Mutable state (immutable updates only)
- ‚ùå Direct CM database access (use proxy/API)
- ‚ùå Mixing paradigms (functional + class)

---

## RELATED DOCUMENTATION

**For detailed patterns, see individual .mdc files:**
- `monorepo-structure-and-configuration.rules.mdc` - Full monorepo setup
- `tests.unified-testing.rules.mdc` - Complete testing guide
- `component-design-decision-tree.rules.mdc` - UI pattern selection
- `monorepo-node-express-architecture.rules.mdc` - Express architecture
- `node.functional-isolated-concerns.rules.mdc` - Functional patterns

**Generated formats available:**
- `.clinerules` (Cline)
- `.windsurfrules` (Windsurf)
- `CLAUDE.md` (Claude.ai - hierarchical by context)
- `GEMINI.md` (Google Gemini)
- `AGENTS.md` (Codex/autonomous agents)
