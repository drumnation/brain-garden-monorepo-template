---
description: Core monorepo foundation - structure, ESM, environment variables
globs:
  - "**/*"
alwaysApply: true
scopes:
  - monorepo
  - global
---

# Monorepo Foundation

## Core Principles
- **ESM-Only:** ES Modules exclusively. No CommonJS.
- **No Build for Libraries:** Packages export TypeScript source directly.
- **Shared Config:** All tooling centralized in `/tooling`. Never duplicate.
- **Agent Coordination:** Check `_errors/` and `_logs/` before running commands.

## Structure
```
/apps          # Executable applications (@scala-cme/[app-name])
/packages      # Shared libraries (@scala-cme/[package-name])
/tooling       # Shared config (@kit/*)
/_errors       # Validation reports (brain-monitor)
/_logs         # Real-time server logs
```

### Naming Patterns
- `/apps` → `@scala-cme/client`, `@scala-cme/server`
- `/packages` → `@scala-cme/shared-ui`, `@scala-cme/shared-redux`
- `/tooling` → `@kit/env-loader`, `@kit/eslint`, etc.

## Package Configuration Templates

### `package.json` for Libraries (/packages)
```json
{
  "name": "@scala-cme/[package-name]",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "exports": {
    ".": "./src/index.ts",
    "./*": "./src/*.ts"
  },
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "files": ["src"],
  "scripts": {
    "clean": "rimraf node_modules .turbo",
    "format": "prettier --check \"**/*.{ts,tsx,md}\"",
    "lint": "eslint . --ext .ts,.tsx",
    "typecheck": "tsc --noEmit",
    "test": "vitest run"
  },
  "devDependencies": {
    "@kit/eslint-config": "workspace:*",
    "@kit/prettier-config": "workspace:*",
    "@kit/testing": "workspace:*",
    "@kit/tsconfig": "workspace:*"
  },
  "eslintConfig": {
    "root": true,
    "extends": ["@kit/eslint-config/base"]
  },
  "prettier": "@kit/prettier-config"
}
```

### `tsconfig.json` for Libraries
**Note:** No `outDir` or `declaration` - we export source directly.
```json
{
  "extends": "@kit/tsconfig/node",
  "include": ["src"],
  "exclude": ["node_modules"]
}
```

## Turbo Pipeline Configuration

### Root `turbo.json`
```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "!.next/cache/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": { "cache": true },
    "typecheck": { "cache": true },
    "test": {
      "dependsOn": ["^build"],
      "cache": true
    },
    "validate": {
      "dependsOn": ["lint", "typecheck", "test"],
      "cache": true
    }
  }
}
```

## Environment Variables (@kit/env-loader)
**Loading order:** `monorepo-root/.env` → `apps/my-app/.env` → `process.env`

```typescript
// Node.js
import { loadEnvironment, requireEnv } from '@kit/env-loader/node';
const result = loadEnvironment({ appName: 'api', required: ['DATABASE_URL'] });

// Browser (prefix with VITE_)
import { getEnv } from '@kit/env-loader/browser';
const API_URL = getEnv('VITE_API_URL', 'http://localhost:8080');
```
