---
description: "Storybook story guidelines and best practices"
globs:
  - "**/*.stories.tsx"
  - "apps/storybook/**/*"
  - "packages/storybook-helpers/**/*"
alwaysApply: false
scopes:
  - react
  - storybook
  - testing
  - ui
---

# Storybook Story Guidelines

> **When to apply:** Writing or maintaining Storybook stories

> **Scopes:** react, storybook, testing, ui

## File Location

- Stories MUST be co-located with their components
- Naming: `ComponentName.stories.tsx` next to `ComponentName.tsx`
- Stories are excluded from package builds via tsconfig
- Example: `packages/shared-ui/src/components/1-atoms/Button/Button.stories.tsx`

## Import Patterns

### Component Imports

```typescript
// ✅ CORRECT - Use relative imports for the component being documented
import { Button } from './Button';
import { Card } from '../Card';

// ❌ WRONG - Don't import from workspace package in same package
import { Button } from '@scala-cme/shared-ui';
```

### Shared Utilities

```typescript
// ✅ CORRECT - Import from storybook-helpers
import { Container } from '@scala-cme/storybook-helpers/components';
import { mockRoles } from '@scala-cme/storybook-helpers/mocks';

// ❌ WRONG - Don't use relative paths to shared utilities
import { Container } from '../../../storybook/components/Container';
```

### Testing Utilities

```typescript
// ✅ CORRECT - Import testing utilities from Storybook packages
import { expect } from '@storybook/test';
import { userEvent, within } from '@storybook/testing-library';
import type { Meta, StoryObj } from '@storybook/react';

// ❌ WRONG - Don't import from testing-library directly
import { render, screen } from '@testing-library/react';
```

### Icon Imports

```typescript
// ✅ CORRECT - Import icons from Radix UI
import { MagnifyingGlassIcon, Cross2Icon } from '@radix-ui/react-icons';
```

## Story Structure

### Meta Object

```typescript
const meta: Meta<typeof ComponentName> = {
  title: 'package-name/folder-structure/ComponentName',
  component: ComponentName,
  tags: ['autodocs'],
  argTypes: {
    // Define controls for component props
    variant: {
      control: 'select',
      options: ['primary', 'secondary', 'ghost'],
    },
  },
};

export default meta;
type Story = StoryObj<typeof ComponentName>;
```

### Story Naming

```typescript
// ✅ CORRECT - Descriptive names that explain the use case
export const Default: Story = {};
export const WithIcon: Story = {};
export const DisabledState: Story = {};
export const LoadingState: Story = {};

// ❌ WRONG - Generic names
export const Story1: Story = {};
export const Test: Story = {};
```

### Story Title Convention

```typescript
// Title should match the package and component hierarchy
// Format: 'package-name/atomic-level/ComponentName'

// Shared UI examples
title: 'shared-ui/1-atoms/Button'
title: 'shared-ui/2-molecules/BaseModal'
title: 'shared-ui/3-organisms/SearchBar'

// Admin UI examples
title: 'admin-ui/Roles'
title: 'admin-ui/UserManagement/Users'

// Navigation UI examples
title: 'navigation-ui/AppNavigation'
title: 'navigation-ui/LoginScreen'

// Plugin examples
title: 'plugins/displays/Displays'
title: 'plugins/flight-boards/FlightBoards'
```

## Testing Requirements

### Play Functions

Every interactive story SHOULD have a `play` function:

```typescript
export const InteractiveExample: Story = {
  args: {
    onClick: fn(), // Use fn() from @storybook/test for action logging
  },
  play: async ({ canvasElement }) => {
    const canvas = within(canvasElement);

    // Use testIds for element selection
    const button = canvas.getByTestId('button-submit');

    // Verify element exists
    expect(button).toBeInTheDocument();

    // Test user interactions
    await userEvent.click(button);

    // Verify results
    expect(button).toHaveAttribute('aria-pressed', 'true');
  },
};
```

### Test Best Practices

```typescript
// ✅ CORRECT - Use within() to scope queries
const canvas = within(canvasElement);
const button = canvas.getByTestId('button-submit');

// ❌ WRONG - Don't use screen queries (can conflict with other stories)
import { screen } from '@storybook/testing-library';
const button = screen.getByTestId('button-submit');

// ✅ CORRECT - Test user interactions
await userEvent.click(button);
await userEvent.type(input, 'Hello World');

// ✅ CORRECT - Verify element attributes and content
expect(button).toHaveTextContent('Submit');
expect(input).toHaveValue('Hello World');

// ✅ CORRECT - Test accessibility
expect(button).toHaveAttribute('aria-label', 'Submit form');
```

### TestIds

```typescript
// Always use testIds from the testids package
import { ButtonTestIds } from '@scala-cme/testids';

// Use testIds in play functions
const button = canvas.getByTestId(ButtonTestIds.submit);
```

## Decorators

### Global Decorators

Global decorators are configured in `apps/storybook/.storybook/preview.tsx`:
- Redux Provider
- ThemeProvider
- I18nProvider
- MSW (Mock Service Worker)
- MemoryRouter

Don't duplicate global setup in individual stories.

### Story-Specific Decorators

```typescript
export const CustomLayoutExample: Story = {
  decorators: [
    (Story) => (
      <div style={{ padding: '2rem', maxWidth: '800px' }}>
        <Story />
      </div>
    ),
  ],
};
```

## Mock Data

### Shared Mock Data

```typescript
// ✅ CORRECT - Put shared mock data in storybook-helpers
// File: packages/storybook-helpers/src/mocks/mockRolesData.ts
export const mockRoles: Role[] = [...];

// Import in stories
import { mockRoles } from '@scala-cme/storybook-helpers/mocks';
```

### Component-Specific Mock Data

```typescript
// ✅ CORRECT - Inline mock data for component-specific stories
export const WithMockData: Story = {
  args: {
    user: {
      id: '1',
      name: 'John Doe',
      email: 'john@example.com',
    },
  },
};

// ✅ CORRECT - Or in a separate file next to the story
// File: ComponentName.mock.ts
export const mockUser = {...};
```

## Accessibility

### Semantic HTML

```typescript
// ✅ CORRECT - Use semantic HTML in examples
<button type="button" aria-label="Close">
  <Cross2Icon />
</button>

// ❌ WRONG - Don't use divs for interactive elements
<div onClick={handleClose}>
  <Cross2Icon />
</div>
```

### Keyboard Navigation

```typescript
// Test keyboard navigation where applicable
export const KeyboardNavigation: Story = {
  play: async ({ canvasElement }) => {
    const canvas = within(canvasElement);
    const input = canvas.getByRole('textbox');

    // Test keyboard interaction
    await userEvent.tab(); // Focus first element
    await userEvent.keyboard('{Enter}'); // Press enter

    expect(input).toHaveFocus();
  },
};
```

### ARIA Labels

```typescript
// ✅ CORRECT - Always provide aria-labels for icon-only buttons
<button aria-label="Delete item">
  <TrashIcon />
</button>

// ✅ CORRECT - Use aria-labelledby for complex labels
<button aria-labelledby="delete-label">
  <TrashIcon />
  <span id="delete-label">Delete</span>
</button>
```

## Story Organization

### Multiple Variants

```typescript
// ✅ CORRECT - Create separate stories for each meaningful variant
export const Primary: Story = {
  args: { variant: 'primary' },
};

export const Secondary: Story = {
  args: { variant: 'secondary' },
};

export const WithIcon: Story = {
  args: {
    variant: 'primary',
    icon: <MagnifyingGlassIcon />,
  },
};
```

### State Stories

```typescript
// ✅ CORRECT - Show different component states
export const Default: Story = {};

export const Loading: Story = {
  args: { isLoading: true },
};

export const Error: Story = {
  args: { error: 'Something went wrong' },
};

export const Disabled: Story = {
  args: { disabled: true },
};
```

## Args vs Render

### Use Args (Preferred)

```typescript
// ✅ CORRECT - Use args for simple prop changes
export const WithProps: Story = {
  args: {
    title: 'Hello World',
    disabled: false,
  },
};
```

### Use Render (When Necessary)

```typescript
// ✅ CORRECT - Use render when you need more control
export const WithComplexSetup: Story = {
  render: (args) => (
    <div>
      <ComponentName {...args} />
      <p>Additional context</p>
    </div>
  ),
  args: {
    title: 'Complex Example',
  },
};
```

## Documentation

### Component Description

```typescript
const meta: Meta<typeof ComponentName> = {
  title: 'shared-ui/1-atoms/Button',
  component: ComponentName,
  tags: ['autodocs'],
  parameters: {
    docs: {
      description: {
        component: 'A versatile button component that supports multiple variants, sizes, and icons.',
      },
    },
  },
};
```

### Story Description

```typescript
export const WithIcon: Story = {
  args: { icon: <MagnifyingGlassIcon /> },
  parameters: {
    docs: {
      description: {
        story: 'Buttons can include icons to provide visual context.',
      },
    },
  },
};
```

## Performance

### Lazy Loading

```typescript
// ✅ CORRECT - Lazy load heavy components
const HeavyComponent = lazy(() => import('./HeavyComponent'));

export const LazyLoaded: Story = {
  render: (args) => (
    <Suspense fallback={<div>Loading...</div>}>
      <HeavyComponent {...args} />
    </Suspense>
  ),
};
```

## Common Pitfalls

### ❌ Don't Import from Same Package

```typescript
// ❌ WRONG
import { Button } from '@scala-cme/shared-ui';

// ✅ CORRECT
import { Button } from './Button';
```

### ❌ Don't Duplicate Global Providers

```typescript
// ❌ WRONG - ThemeProvider is already global
export const Themed: Story = {
  decorators: [
    (Story) => (
      <ThemeProvider theme={theme}>
        <Story />
      </ThemeProvider>
    ),
  ],
};

// ✅ CORRECT - Trust global providers
export const Themed: Story = {
  args: { variant: 'primary' },
};
```

### ❌ Don't Skip TestIds

```typescript
// ❌ WRONG - Using text queries is brittle
const button = canvas.getByText('Submit');

// ✅ CORRECT - Use testIds
const button = canvas.getByTestId('button-submit');
```

## Summary Checklist

When creating or reviewing a story:

- [ ] Story file is co-located with component (`ComponentName.stories.tsx`)
- [ ] Uses relative imports for the component being documented
- [ ] Uses `@scala-cme/storybook-helpers` for shared utilities
- [ ] Imports testing utilities from `@storybook/test` and `@storybook/testing-library`
- [ ] Title follows package hierarchy convention
- [ ] Meta object includes `title`, `component`, and `tags`
- [ ] Stories have descriptive names (not `Story1`, `Test`, etc.)
- [ ] Interactive stories have `play` functions
- [ ] Play functions use `within(canvasElement)` for scoped queries
- [ ] TestIds are used for element selection
- [ ] Accessibility attributes are present (aria-labels, semantic HTML)
- [ ] No duplicate global providers in decorators
- [ ] Mock data is either inline or in `@scala-cme/storybook-helpers/mocks`
- [ ] Args are used for simple prop changes, render for complex setups
