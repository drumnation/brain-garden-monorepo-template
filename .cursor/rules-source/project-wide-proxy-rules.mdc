---
description: Project-wide API proxy patterns and middleware configuration
globs:
  - "apps/server/src/modules/proxy/**/*"
  - "apps/server/src/middleware/**/*"
scopes:
  - backend
  - api
  - proxy
  - middleware
alwaysApply: false
---
## Project-Wide Proxy Rules

This project uses a proxy server (`@cortals/server` workspace, code in `apps/server`) to mediate communication between the frontend application (Portals) and the backend Content Manager (CM) server.  These rules are designed to clarify when and how to interact with the proxy and the local database (`@cortals/pg-service` workspace).

**Rule 1: Proxy for CM API Requests**
   - **Description:** All requests intended for the Content Manager API must be routed through the proxy server. The proxy server is responsible for handling authentication, request transformation, and response interception before forwarding requests to the CM server.
   - **Rationale:** This ensures consistent interaction with the CM API, allows for centralized handling of concerns like authentication and data augmentation, and provides a point of control for interacting with the legacy CM system.
   - **Example:** When fetching users, roles, or workgroups from Content Manager, the request should be directed to the proxy endpoints (e.g., `/api/cm/users`, `/api/cm/roles`, `/api/cm/workgroups`).

**Rule 2: Local Database for Portal-Specific Data**
   - **Description:** The local PostgreSQL database (`@cortals/pg-service`) should be used for managing data that is specific to the Portals application and does not directly reside within Content Manager. This includes permission groups, portal-specific user roles, and any other data needed for the Portals frontend functionality.
   - **Rationale:**  This allows Portals to manage its own data independently of the CM system, enabling features and customizations that are specific to the portal application.
   - **Example:**  Managing permission groups, their children, and mappings should be done by directly querying and modifying the local database using functions from `@cortals/pg-service/query/cortals`.

**Rule 3: No Direct Local Database Modifications for CM Data**
   - **Description:**  Do not attempt to use the local database to directly modify or access data that is primarily managed by Content Manager. The Content Manager database is not directly accessible, and all interactions with CM data should occur through the CM API via the proxy.
   - **Rationale:**  Direct database modifications could lead to data inconsistencies, bypass CM's business logic and security measures, and create maintenance headaches.
   - **Exception:** Caching or storing a subset of CM data in the local database for performance or specific portal features is acceptable, but the source of truth remains the CM system, and updates should be synchronized via the CM API.

**Rule 4: Proxy Bypass for Portal-Internal Requests**
   - **Description:** Requests that are internal to the Portals application and do not interact with the Content Manager API should bypass the proxy. This includes requests for static assets, health checks, and any portal-specific API endpoints that operate solely on the local database or application logic.
   - **Rationale:**  Sending internal requests through the proxy adds unnecessary overhead and complexity. Direct communication within the Portals application components is more efficient for internal operations.
   - **Example:** Requests to `/health` endpoint, serving static files from the `client/dist` directory, or accessing portal-specific permission group APIs should not be proxied.

**Rule 5: CM API Token Handling**
    - **Description:** When making requests to the CM API through the proxy, API tokens are required for authentication. The proxy server is responsible for obtaining and managing these tokens.  **Crucially, when including the token in headers for CM API requests, use the token value directly, without the "Bearer" prefix.**
    - **Rationale:** The CM API authentication scheme expects the API token directly in the `apiToken` header, not in the standard "Bearer" format.  Following this convention is essential for successful authentication.
    - **Reference:** See `services/cm/src/api/auth.ts` for how tokens are obtained and `services/cm/src/proxy/proxy.ts` for how they are used in proxy requests.
    - **Cursor Rule File:**  `cm-proxy-rules.mdc` (Rule file provided earlier in the conversation)

**Directory Specific Rules for `@cm` (services/cm):**

**Rule 6: `@cm` Workspace - Proxy Server Logic**
    - **Description:** The `@cm` workspace contains the code for the proxy server logic, including middleware, request routing, and API interaction with Content Manager.  Code in this directory is responsible for handling requests intended for the CM API and mediating between the Portals frontend and the CM backend.
    - **Rationale:**  Encapsulating proxy logic within the `@cm` workspace promotes modularity and separation of concerns. It clearly delineates the code responsible for proxying CM requests from other parts of the application.
    - **Location:**  `services/cm/*`
    - **Key Files:**
        - `services/cm/src/proxy/*`: Contains proxy middleware and request handling logic.
        - `services/cm/src/api/*`:  Defines API interaction functions (e.g., token retrieval, role fetching).
        - `services/cm/src/middleware/*`: Includes middleware for authentication and request modification.
        - `services/cm/src/proxy/router.ts`: Defines routing logic for proxy responses and custom handling.

**Rule 7: `@cm` Workspace - No Direct Database Access (Except Portal DB)**
    - **Description:** Code within the `@cm` workspace should primarily interact with the Content Manager API.  Direct access to the Content Manager database is prohibited.  However, it *can* interact with the Portals PostgreSQL database (`@cortals/pg-service`) for purposes like storing API keys or augmenting CM data with portal-specific information.
    - **Rationale:**  Maintaining a clear separation between proxy logic and direct CM database access is crucial for architectural integrity and maintainability.  Interactions with the Portals database are acceptable for supporting proxy functionality and portal features.
    - **Database Interaction:** When database interaction is needed, use the `db` object exported from `services/cm/src/db.ts`, which is a wrapper around `@cortals/pg-service`.

**Mermaid Diagram:**

```mermaid
graph LR
    subgraph Frontend Application (Portals)
        FE[Frontend App (Portals)]
    end

    subgraph Server Workspace (`@cortals/server`)
        ProxyServer[Proxy Server (`@cortals/server`)]
        OpenAPI[OpenAPI Spec (`openapi.yaml`)]
    end

    subgraph CM Service Workspace (`@cortals/cm-service`)
        ProxyCode[Proxy Code (`@cortals/cm-service/src/proxy/*`)]
    end

    subgraph Portal Database Workspace (`@cortals/pg-service`)
        PortalDB[Portal DB (`@cortals/pg-service`)]
    end

    subgraph Backend Server (Content Manager)
        CMServer[Backend Server (CM)]
        CMDB[CM Database (Implicit Access)]
    end

    FE --> ProxyServer: CM API Requests
    FE -->> PortalServerInternal: Portal-Internal Requests (e.g., Static Files, Health)
    ProxyServer -->> PortalDB: Portal Data Queries/Updates
    ProxyServer --> CMServer: Proxied CM API Requests
    CMServer --> CMDB: Implicit DB Access
    CMServer --> ProxyServer: CM API Responses
    ProxyServer --> FE: Proxied CM API Responses
    ProxyCode --o ProxyServer: Implements Proxy Logic
    OpenAPI --o ProxyServer: Documents Proxy API


    style ProxyServer fill:#f9f,stroke:#333,stroke-width:2px
    style PortalDB fill:#ccf,stroke:#333,stroke-width:2px
    style CMServer fill:#efe,stroke:#333,stroke-width:2px
    style CMDB fill:#eee,stroke:#333,stroke-width:2px
    style FE fill:#cee,stroke:#333,stroke-width:2px
    style ProxyCode fill:#fcf,stroke:#333,stroke-width:2px
    style OpenAPI fill:#fce,stroke:#333,stroke-width:2px

    classDef internal stroke-dasharray: 5 5;
    class PortalServerInternal internal;
```

**Explanation of the Diagram:**

* **Components:** The diagram clearly outlines the major components: Frontend App, Proxy Server, CM Server, Portal DB, and CM DB. It also highlights the location of the OpenAPI spec and Proxy code.
* **Request Flow:** Arrows indicate the direction of requests and responses.
    * Solid arrows represent CM API requests going through the proxy.
    * Dashed arrows represent Portal-internal requests bypassing the proxy.
* **Data Flow:** Arrows also show data flow, such as the Proxy Server interacting with the Portal DB.
* **Workspace and Code Location:** Subgraphs and labels indicate the workspace and key code locations for different components, especially for the Proxy Server and Proxy Code.
* **Implicit CM DB Access:** The CM DB is marked as "Implicit Access" to emphasize that Portals and the Proxy Server do not directly interact with it; access is only through the CM Server.
* **Styling:**  Different colors and styles are used to visually distinguish the components and their roles.
